# Telegraf Configuration for Home Automation Infrastructure
# Version: 1.30+ compatible with all deprecations fixed

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "30s"
  flush_jitter = "0s"
  precision = ""
  hostname = "ha-server2"
  omit_hostname = false
  # Fix future deprecation warning
  skip_processors_after_aggregators = false

# InfluxDB v2 Output
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"

# System Metrics
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]

[[inputs.kernel]]

[[inputs.mem]]

[[inputs.processes]]

[[inputs.swap]]

[[inputs.system]]

# Network - Fixed deprecation warning
[[inputs.net]]
  interfaces = ["eth*", "en*"]

# Use nstat for protocol stats (as recommended)
[[inputs.nstat]]
  proc_net_netstat = "/hostfs/proc/net/netstat"
  proc_net_snmp = "/hostfs/proc/net/snmp"
  proc_net_snmp6 = "/hostfs/proc/net/snmp6"
  dump_zeros = true

[[inputs.netstat]]

# Docker Metrics - Fixed all deprecation warnings
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  gather_services = false
  source_tag = false
  container_name_include = []
  container_name_exclude = []
  timeout = "5s"
  perdevice_include = ["cpu", "blkio", "network"]
  total = false
  docker_label_include = []
  docker_label_exclude = []

# PostgreSQL Metrics
[[inputs.postgresql]]
  address = "postgres://hass:${POSTGRES_PASSWORD}@postgres:5432/homeassistant?sslmode=disable"
  databases = ["homeassistant"]

# MQTT Broker Metrics
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "$SYS/broker/load/+",
    "$SYS/broker/clients/+", 
    "$SYS/broker/messages/+",
    "$SYS/broker/subscriptions/+"
  ]
  data_format = "value"
  data_type = "float"

# Home Assistant API Metrics
[[inputs.http]]
  name_override = "homeassistant"
  urls = ["http://homeassistant:8123/api/states"]
  headers = {"Authorization" = "Bearer ${HA_TOKEN}"}
  data_format = "json"
  json_query = "length"
  timeout = "10s"
  interval = "60s"

# Pi-hole v6 Metrics (using exec script)
[[inputs.exec]]
  commands = ["/etc/telegraf/piholeStats.sh"]
  timeout = "60s"
  data_format = "influx"
  interval = "60s"

# SSL Certificate Monitoring
[[inputs.x509_cert]]
  sources = [
    "https://ha.martin-ohana.com:443",
    "https://nodered.martin-ohana.com:443", 
    "https://zwavejs.martin-ohana.com:443",
    "https://portainer.martin-ohana.com:443",
    "https://pgadmin.martin-ohana.com:443",
    "https://grafana.martin-ohana.com:443",
    "https://influxdb.martin-ohana.com:443"
  ]
  timeout = "10s"

# Remote Server Health Checks (fixed SSH key permissions)
[[inputs.exec]]
  commands = [
    "ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i /tmp/id_rsa_monitoring cliffm@192.168.1.65 'echo \"remote_health,server=raspberrypi,host=192.168.1.65 status=1\"'",
    "ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i /tmp/id_rsa_monitoring cliffm@192.168.30.25 'echo \"remote_health,server=tartlet,host=192.168.30.25 status=1\"'"
  ]
  timeout = "30s"
  data_format = "influx"
  interval = "300s"

# Network Connectivity Tests - FIXED ping_timeout issue
[[inputs.ping]]
  urls = ["192.168.1.1", "192.168.1.65", "192.168.30.25", "8.8.8.8"]
  count = 3
  timeout = 1.0
  deadline = 10

